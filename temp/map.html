<!DOCTYPE html>
<html>
<head>
    <title>Fire Hotspots</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        #map { height: 500px; width: 100%; border: 1px solid #ddd; border-radius: 5px; margin-top: 10px; }
        .controls { margin: 10px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6; }
        .checkbox-group { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 10px; }
        label { cursor: pointer; padding: 5px 10px; border-radius: 3px; transition: background 0.2s; }
        label:hover { background: #e9ecef; }
        input[type="checkbox"] { margin-right: 5px; }
        .legend { font-size: 14px; }
    </style>
</head>
<body>
    <h2>Fire Hotspots Map</h2>
    <p>Select one or more layers to display on the map.</p>

    <div class="controls">
        <strong>Select Map Layers:</strong>
        <div class="checkbox-group">
            {% for file in geojson_files %}
            <label>
                <input type="checkbox" name="geojsonFile" value="{{ file }}" checked>
                {{ file.replace('.geojson', '').replace('_', ' ').title() }}
            </label>
            {% endfor %}
        </div>
    </div>

    <div id="map"></div>

    <script>
        var map = L.map('map').setView([-17, 30], 6);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        var layers = {};
        var colors = ['#ff3333','#33cc33','#3366ff','#ff9933','#9900cc','#00cccc','#ff66cc','#cccc00'];
        var colorIndex = 0;

        function getNextColor() {
            var color = colors[colorIndex % colors.length];
            colorIndex++;
            return color;
        }

        
        function formatPopup(feature) {
            const props = feature.properties || {};
            let content = '<div>';
            if (props.name) content += `<b>${props.name}</b><br>`;
            Object.keys(props).forEach(k => { content += `${k}: ${props[k]}<br>`; });
            content += '</div>';
            return content;
        }

        function addLegend(layerName, color) {
            // Remove existing legend if any
            var existingLegend = document.querySelector('.legend');
            if (existingLegend) existingLegend.remove();

            var legend = L.control({ position: 'bottomright' });

            legend.onAdd = function(map) {
                var div = L.DomUtil.create('div', 'legend');
                div.style.background = '#fff';
                div.style.padding = '8px';
                div.style.border = '1px solid #ccc';
                div.style.borderRadius = '4px';
                div.innerHTML = `<div style="display:flex;align-items:center;">
                                    <div style="width:20px;height:20px;background:${color};margin-right:8px;border:1px solid #000;"></div>
                                    <span>${layerName}</span>
                                 </div>`;
                return div;
            };

            legend.addTo(map);
        }

        function loadLayer(file) {
            if (layers[file]) {
                map.addLayer(layers[file].layer);
                addLegend(file.replace('.geojson','').replace('_',' ').toUpperCase(), layers[file].color);
                return;
            }

            var layerColor = getNextColor();
            fetch('/data/' + file)
                .then(res => res.json())
                .then(data => {
                    var layer = L.geoJSON(data, {
                        pointToLayer: function(feature, latlng) {
                            return L.circleMarker(latlng, {
                                radius: 6,
                                fillColor: layerColor,
                                color: '#000',
                                weight: 1,
                                opacity: 1,
                                fillOpacity: 0.8
                            });
                        },
                        style: function(feature) {
                            return { color: layerColor, weight: 2, fillOpacity: 0.1 };
                        },
                        onEachFeature: function(feature, l) {
                            l.bindPopup(formatPopup(feature));
                        }
                    }).addTo(map);

                    layers[file] = { layer: layer, color: layerColor };
                    addLegend(file.replace('.geojson','').replace('_',' ').toUpperCase(), layerColor);
                    fitMapBounds();
                })
                .catch(err => console.error('Error loading', file, err));
        }

        function removeLayer(file) {
            if (layers[file]) {
                map.removeLayer(layers[file].layer);
            }
        }

        function fitMapBounds() {
            var visibleLayers = Object.values(layers)
                                      .filter(l => map.hasLayer(l.layer))
                                      .map(l => l.layer);
            if (visibleLayers.length) {
                var group = L.featureGroup(visibleLayers);
                map.fitBounds(group.getBounds(), { padding: [50,50] });
            }
        }

        document.querySelectorAll('input[name="geojsonFile"]').forEach(cb => {
            if (cb.checked) loadLayer(cb.value);
            cb.addEventListener('change', function() {
                if (this.checked) loadLayer(this.value);
                else removeLayer(this.value);
                fitMapBounds();
            });
        });
    </script>
</body>
</html>
