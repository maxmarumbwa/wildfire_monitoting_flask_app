<!DOCTYPE html>
<html>
<head>
    <title>Fire Hotspots</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        #map { height: 500px; width: 100%; border: 1px solid #ddd; border-radius: 5px; margin-top: 10px; }
        .controls { margin: 10px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6; }
        .checkbox-group { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 10px; }
        label { cursor: pointer; padding: 5px 10px; border-radius: 3px; transition: background 0.2s; }
        label:hover { background: #e9ecef; }
        input[type="checkbox"] { margin-right: 5px; }
    </style>
</head>
<body>
    <h2>Fire Hotspots Map</h2>
    <p>Select one or more layers to display on the map.</p>

    <div class="controls">
        <strong>Select Map Layers:</strong>
        <div class="checkbox-group">
            {% for file in geojson_files %}
            <label>
                <input type="checkbox" name="geojsonFile" value="{{ file }}" checked>
                {{ file.replace('.geojson', '').replace('_', ' ').title() }}
            </label>
            {% endfor %}
        </div>
    </div>

    <div id="map"></div>

    <script>
        var map = L.map('map').setView([-17, 30], 6);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Store all loaded layers
        var layers = {};

        function formatPopup(feature) {
            const props = feature.properties || {};
            let content = '<div>';
            if (props.name) content += `<b>${props.name}</b><br>`;
            Object.keys(props).forEach(k => { content += `${k}: ${props[k]}<br>`; });
            content += '</div>';
            return content;
        }

        function getFeatureStyle(feature) {
            if (feature.geometry.type === 'Point') {
                return {
                    radius: 6,
                    fillColor: '#ff3333',
                    color: '#660000',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                };
            }
            return { color: '#3388ff', weight: 2, fillOpacity: 0.1 };
        }

        function loadLayer(file) {
            if (layers[file]) {
                map.addLayer(layers[file]); // layer already loaded, just show
                return;
            }
            fetch('/data/' + file)
                .then(res => res.json())
                .then(data => {
                    var layer = L.geoJSON(data, {
                        pointToLayer: function(feature, latlng) {
                            return L.circleMarker(latlng, getFeatureStyle(feature));
                        },
                        style: getFeatureStyle,
                        onEachFeature: function(feature, layer) {
                            layer.bindPopup(formatPopup(feature));
                        }
                    }).addTo(map);
                    layers[file] = layer;
                    fitMapBounds();
                })
                .catch(err => console.error('Error loading', file, err));
        }

        function removeLayer(file) {
            if (layers[file]) {
                map.removeLayer(layers[file]);
            }
        }

        function fitMapBounds() {
            var group = L.featureGroup(Object.values(layers).filter(l => map.hasLayer(l)));
            if (group.getLayers().length) {
                map.fitBounds(group.getBounds(), { padding: [50, 50] });
            }
        }

        // Initial load for all checked boxes
        document.querySelectorAll('input[name="geojsonFile"]').forEach(cb => {
            if (cb.checked) loadLayer(cb.value);
            cb.addEventListener('change', function() {
                if (this.checked) loadLayer(this.value);
                else removeLayer(this.value);
                fitMapBounds();
            });
        });
    </script>
</body>
</html>
