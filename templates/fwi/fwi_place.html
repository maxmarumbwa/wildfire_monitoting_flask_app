{% extends "base.html" %}

{% block content %}
<div class="settings-container">
    {% include "header.html" %}
    
    <div id="settings">
        <nav id="left-settings" class="sidebar-title">
            <div class="nav-item sidebar-title">
                <a href="{{ url_for('index') }}"><i class="fas fa-home"></i> Home</a>
            </div>
            <div class="nav-item sidebar-title">
                <a href="{{ url_for('fwi_form') }}"><i class="fas fa-cog"></i> Get FWI by Coordinates</a>
            </div>
            <div class="nav-item sidebar-title">
                <a href="{{ url_for('fwi_map') }}"><i class="fas fa-cog"></i> Get FWI by Map</a>
            </div>
            <div class="nav-item sidebar-title">
                <a href="{{ url_for('fwi_place_page') }}"><i class="fas fa-cog"></i> Get FWI by Place Name</a>
            </div>
        </nav>
        
        <div class="container">
            <h2>Get Weather by Place Name</h2>
            
            <form id="weatherForm">
                <label for="town">Select Town in Zimbabwe</label>
                <select id="town" name="town" required>
                    <option value="" disabled selected>Select a town</option>
                    <option value="Harare">Harare</option>
                    <option value="Bulawayo">Bulawayo</option>
                    <option value="Mutare">Mutare</option>
                    <option value="Gweru">Gweru</option>
                    <option value="Masvingo">Masvingo</option>
                    <option value="Kwekwe">Kwekwe</option>
                    <option value="Chinhoyi">Chinhoyi</option>
                    <option value="Bindura">Bindura</option>
                    <option value="Victoria Falls">Victoria Falls</option>
                    <option value="Kariba">Kariba</option>
                    <option value="Kadoma">Kadoma</option>
                    <option value="Marondera">Marondera</option>
                </select>
                
                <button type="submit">Get Weather</button>
            </form>
            
            <h3>Weather Information:</h3>
            <div id="output">Waiting for selection...</div>
        </div>
    </div>
    
    {% include 'footer.html' %}
</div>

<script>
    document.getElementById("weatherForm").addEventListener("submit", function (e) {
        e.preventDefault();
        
        const town = document.getElementById("town").value;
        
        if (!town) {
            document.getElementById("output").innerHTML = "<p style='color: red;'>Please select a town.</p>";
            return;
        }
        
        // Show loading message
        document.getElementById("output").innerHTML = "<p>Fetching weather data for " + town + "...</p>";
        
        fetch("/fwi/place", {
            method: "POST",
            headers: { 
                "Content-Type": "application/x-www-form-urlencoded" 
            },
            body: `place=${encodeURIComponent(town)}`
        })
        .then(res => {
            if (!res.ok) {
                throw new Error(`HTTP error! Status: ${res.status}`);
            }
            return res.json();
        })
        .then(data => {
            console.log("Response data:", data); // For debugging
            
            // Check for error in response
            if (data.error) {
                document.getElementById("output").innerHTML = 
                    `<p style='color: red;'>Error: ${data.error}</p>`;
                return;
            }
            
            // Check if weather data exists
            if (!data.main || !data.weather) {
                document.getElementById("output").innerHTML = 
                    `<p style='color: red;'>Invalid weather data received</p>`;
                return;
            }
            
            // Extract and display weather information
            const seaLevel = data.main.sea_level ?? "N/A";
            const tempMinC = data.main.temp_min ? (data.main.temp_min - 273.15).toFixed(1) : "N/A";
            const windSpeed = data.wind?.speed ?? "N/A";
            const temperature = data.main.temp ? (data.main.temp - 273.15).toFixed(1) : "N/A";
            const humidity = data.main.humidity ?? "N/A";
            const weatherDesc = data.weather[0]?.description ?? "N/A";
            
            document.getElementById("output").innerHTML = `
                <h4>Weather for ${town}:</h4>
                <ul>
                    <li><strong>Weather:</strong> ${weatherDesc}</li>
                    <li><strong>Temperature:</strong> ${temperature} °C</li>
                    <li><strong>Min Temperature:</strong> ${tempMinC} °C</li>
                    <li><strong>Humidity:</strong> ${humidity}%</li>
                    <li><strong>Sea Level Pressure:</strong> ${seaLevel} hPa</li>
                    <li><strong>Wind Speed:</strong> ${windSpeed} m/s</li>
                </ul>
            `;
        })
        .catch(error => {
            console.error("Fetch error:", error);
            document.getElementById("output").innerHTML = 
                `<p style='color: red;'>Error fetching data: ${error.message}</p>`;
        });
    });
</script>
{% endblock %}